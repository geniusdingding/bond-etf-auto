name: Bond ETF Auto Process

on:
  push:
    paths:
      - 'input/**'
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}   # âœ… å¿…é¡»åŠ è¿™ä¸ªï¼Œå¦åˆ™æ— æ³• push

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run processing script
        run: python main.py

      # âœ… æ–°å¢ï¼šè®¾ç½® Git èº«ä»½ï¼ˆè®© Actions èƒ½ commitï¼‰
      - name: Set git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # âœ… æ–°å¢ï¼šæŠŠæœ€æ–°ç»“æœæäº¤å›ä»“åº“
      - name: Push updated result
        run: |
          git add output/ç§‘åˆ›å€ºETF_ç´¯è®¡ç»“æœ.xlsx
          git commit -m "update result" || echo "no changes"
          git push

      # âœ… ä¿®æ”¹ï¼šç”¨ raw ç›´é“¾å‘é€é£ä¹¦é€šçŸ¥
      - name: Send Feishu notification
        if: success()
        run: |
          DOWNLOAD_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/output/ç§‘åˆ›å€ºETF_ç´¯è®¡ç»“æœ.xlsx"
          curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"msg_type\": \"text\",
                  \"content\": {
                    \"text\": \"âœ… ç§‘åˆ›å€ºæŠ˜ç®—ç‡å·²æ›´æ–°\nğŸ“ æœ€æ–°æ–‡ä»¶ï¼š$DOWNLOAD_URL\"
                  }
                }"
