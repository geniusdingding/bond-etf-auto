name: Bond ETF Auto Process

on:
  push:
    paths:
      - 'input/**'
  workflow_dispatch:

# å¿…é¡»æ·»åŠ å†™å…¥æƒé™ï¼Œå¦åˆ™ push ä¼šæŠ¥ 403 é”™è¯¯
permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡º Main åˆ†æ”¯ä»£ç 
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: main           # æ˜ç¡®æŒ‡å®šæ‹‰å– main åˆ†æ”¯çš„ä»£ç 
          fetch-depth: 0      # è·å–å…¨éƒ¨å†å²ï¼Œæ–¹ä¾¿è·¨åˆ†æ”¯æ“ä½œ

      # 2. è®¾ç½® Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. ğŸŒŸã€å…³é”®æ­¥éª¤ã€‘æŠŠæ˜¨å¤©çš„æ•°æ®ä» auto-updates åˆ†æ”¯â€œå·â€å›æ¥
      # å¦‚æœä¸åŠ è¿™ä¸€æ­¥ï¼Œä½ çš„è„šæœ¬æ¯æ¬¡éƒ½æ˜¯ä»é›¶å¼€å§‹ï¼Œæ— æ³•â€œç´¯è®¡â€ï¼
      - name: Restore History Data
        run: |
          # å°è¯•è·å– auto-updates åˆ†æ”¯çš„æœ€æ–°çŠ¶æ€
          git fetch origin auto-updates || echo "First run, branch not found."
          
          # å°†é‚£ä¸ªåˆ†æ”¯é‡Œçš„ Excel æ–‡ä»¶è¦†ç›–åˆ°å½“å‰ç›®å½•
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼ˆç¬¬ä¸€æ¬¡è¿è¡Œï¼‰ï¼Œåˆ™å¿½ç•¥é”™è¯¯
          git checkout origin/auto-updates -- "output/ç§‘åˆ›å€ºETF_ç´¯è®¡ç»“æœ.xlsx" || echo "No history file found, starting fresh."

      # 4. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. è¿è¡Œè„šæœ¬ (æ­¤æ—¶æœ¬åœ°æ—¢æœ‰ Main çš„ä»£ç ï¼Œä¹Ÿæœ‰æ˜¨å¤©çš„ Excel)
      - name: Run processing script
        run: python main.py

      # 6. è¯»å– config.json (ä½¿ç”¨å®‰å…¨å†™æ³•)
      - name: Read push config
        id: cfg
        run: |
          VALUE=$(python -c "import json;print(json.load(open('config.json'))['push_enabled'])")
          echo "push_enabled=$VALUE" >> $GITHUB_OUTPUT

      # 7. é…ç½® Git èº«ä»½
      - name: Set git identity
        if: ${{ steps.cfg.outputs.push_enabled == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      
      # 8. æäº¤ç»“æœ (ç¡®ä¿è¿™é‡Œåªæœ‰ä¸€æ¬¡ git commit)
      - name: Commit result
        if: ${{ steps.cfg.outputs.push_enabled == 'true' }}
        run: |
          git add "output/*.xlsx"
          git commit -m "Auto update bond ETF rates: $(date +'%Y-%m-%d')" || echo "âš ï¸ No changes to commit"

      # 9. ğŸŒŸã€å…³é”®æ­¥éª¤ã€‘å¼ºåˆ¶æ¨é€åˆ° auto-updates åˆ†æ”¯
      # åŠ ä¸Š --force æ˜¯ä¸ºäº†è§£å†³ non-fast-forward æŠ¥é”™
      # å› ä¸ºæˆ‘ä»¬å·²ç»æŠŠæ—§æ•°æ®â€œå·â€å›æ¥å¹¶æ›´æ–°äº†ï¼Œæ‰€ä»¥è¦†ç›–æ—§åˆ†æ”¯æ˜¯å®‰å…¨çš„
      - name: Push to auto-updates branch
        if: ${{ steps.cfg.outputs.push_enabled == 'true' }}
        run: |
          git push origin HEAD:refs/heads/auto-updates --force